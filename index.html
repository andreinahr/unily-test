<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Bitmovin iOS Fullscreen Fix Test</title>
	<script src="https://cdn.bitmovin.com/player/web/8/bitmovinplayer.js"></script>
	<style>
		body {
			font-family: sans-serif;
			padding: 20px;
			background: #fafafa;
			text-align: center;
		}
		#player {
			width: 100%;
			max-width: 640px;
			aspect-ratio: 16/9;
			margin: 20px auto;
			background: #000;
		}
		button {
			margin: 10px;
			padding: 10px 20px;
			font-size: 14px;
			cursor: pointer;
			border-radius: 6px;
			border: none;
			background-color: #007bff;
			color: white;
		}
		button:hover {
			background-color: #0056b3;
		}
	</style>
</head>
<body>
	<h2>Bitmovin iOS Fullscreen Fix Test</h2>
	<div id="player"></div>
	<div>
		<button id="loadTest">Load Test Video (Public)</button>
		<button id="loadTestAudio">Load Test Audio (Public MP3)</button>
		<button id="addSubtitlesManually">Add Subtitles Manually</button>
		<button id="checkSubtitles">Check Available Subtitles</button>
		<button id="enableSubtitles">Enable First Subtitle</button>
		<button id="disableSubtitles">Disable Subtitles</button>
	</div>

	<script>
		let player;

		// Initialize player when DOM is ready
		document.addEventListener('DOMContentLoaded', () => {
			console.log('DOM loaded, initializing player...');

			// === Bitmovin player configuration ===
			const playerConfig = {
				key: 'ec217a70-d15c-42db-bdfb-70d3d2725063',
				playback: { autoplay: false },
			};

			const playerContainer = document.getElementById('player');
			player = new bitmovin.player.Player(playerContainer, playerConfig);

			// Add event listeners for debugging
			player.on('ready', () => {
				console.log('Player is ready');
			});

			player.on('error', (event) => {
				console.error('Player error:', event);
			});

			player.on('sourceloaded', () => {
				console.log('Source loaded successfully');
				
				// Check subtitles after source loads
				setTimeout(() => {
					const subtitles = player.subtitles.list();
					console.log('Available subtitles after source load:', subtitles);
					if (subtitles.length > 0) {
						console.log('Subtitles loaded successfully:', subtitles.map(s => s.label));
						// Optionally enable the first subtitle
						// player.subtitles.enable(subtitles[0].id);
					} else {
						console.log('No subtitles available from source');
					}
				}, 1000);
			});

			player.on('sourceerror', (event) => {
				console.error('Source error:', event);
			});
			console.log('Player instance created:', player);
			console.log('Player initialized');
		});

		// === Test source (public, no auth required) ===
		const testSource = {
			hls: 'https://cdn.bitmovin.com/content/assets/art-of-motion-dash-hls-progressive/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8',
			// Add subtitles properly in source config
			subtitles: [
				{
					url: 'https://bitdash-a.akamaihd.net/content/sintel/subtitles/subtitles_en.vtt',
					label: 'English',
					id: 'en_sub',
					lang: 'en',
					kind: 'subtitles'
				},
				{
					url: 'https://bitdash-a.akamaihd.net/content/sintel/subtitles/subtitles_de.vtt',
					label: 'German',
					id: 'de_sub', 
					lang: 'de',
					kind: 'subtitles'
				}
			]
		};

		// === Test audio source (public MP3) ===
		const testAudioSource = {
			progressive: 'https://archive.org/download/testmp3testfile/mpthreetest.mp3'
		};

		// === Load sources ===
		async function loadSource(source, type) {
			try {
				console.log(`Starting to load ${type} source:`, source);

				console.log('Unloading previous source...');
				await player.unload();

			console.log('Loading new source...');
			await player.load(source);

			console.log(`${type} source loaded successfully!`);
			} catch (error) {
				console.error(`Error loading ${type}:`, error);
				console.error('Error details:', {
					name: error.name,
					message: error.message,
					code: error.code,
					data: error.data
				});
				alert(`Failed to load ${type}: ${error.message || error.code || 'Unknown error'}`);
			}
		}

		// === Button handlers ===
		document.addEventListener('DOMContentLoaded', () => { 
			document.getElementById('loadTest').addEventListener('click', async () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				await loadSource(testSource, 'test video');
			});

			document.getElementById('loadTestAudio').addEventListener('click', async () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				await loadSource(testAudioSource, 'test audio');
			});

			document.getElementById('addSubtitlesManually').addEventListener('click', async () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				
				try {
					console.log('Manual subtitle addition attempt...');
					
					// Use the correct Bitmovin API for adding subtitles
					const subtitleConfig = {
						url: 'https://bitdash-a.akamaihd.net/content/sintel/subtitles/subtitles_fr.vtt',
						label: 'French (Manual)',
						id: 'fr_manual',
						lang: 'fr',
						kind: 'subtitles'
					};
					
					// Check if we can add subtitles to the current source
					const currentSource = player.getSource();
					if (currentSource) {
						console.log('Current source:', currentSource);
						
						// Method 1: Try adding to the source and reload
						const newSource = {
							...currentSource,
							subtitles: [
								...(currentSource.subtitles || []),
								subtitleConfig
							]
						};
						
						console.log('Reloading with new subtitle...');
						await player.load(newSource);
						
						alert('Subtitle added successfully! Check the subtitles menu.');
					} else {
						alert('No source loaded. Please load a video first.');
					}
					
				} catch (error) {
					console.error('Manual subtitle addition failed:', error);
					alert('Failed to add subtitle: ' + error.message);
				}
			});

			document.getElementById('checkSubtitles').addEventListener('click', () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				const subtitles = player.subtitles.list();
				console.log('Available subtitles:', subtitles);
				
				let message = `Available subtitles: ${subtitles.length}\n`;
				if (subtitles.length > 0) {
					subtitles.forEach((sub, index) => {
						message += `${index + 1}. ${sub.label} (${sub.lang || sub.language}) - ID: ${sub.id}\n`;
					});
				} else {
					message += 'None found. Make sure to load a video with subtitles first.';
				}
				
				alert(message);
			});

			document.getElementById('enableSubtitles').addEventListener('click', () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				
				const subtitles = player.subtitles.list();
				if (subtitles.length > 0) {
					try {
						player.subtitles.enable(subtitles[0].id);
						console.log('Enabled subtitle:', subtitles[0].label);
						alert(`Enabled subtitle: ${subtitles[0].label}`);
					} catch (error) {
						console.error('Error enabling subtitle:', error);
						alert('Error enabling subtitle: ' + error.message);
					}
				} else {
					alert('No subtitles available to enable');
				}
			});

			document.getElementById('disableSubtitles').addEventListener('click', () => {
				if (!player) {
					alert('Player not initialized yet');
					return;
				}
				
				try {
					player.subtitles.disable();
					console.log('Subtitles disabled');
					alert('Subtitles disabled');
				} catch (error) {
					console.error('Error disabling subtitles:', error);
					alert('Error disabling subtitles: ' + error.message);
				}
			});
		});
	</script>
</body>
</html>
